from bs4 import BeautifulSoup
import json
import os

html_file = "34637595.html"  # Replace with your file
page_id = os.path.splitext(os.path.basename(html_file))[0]
json_file = f"{page_id}.json"

# Load HTML
with open(html_file, "r", encoding="utf-8") as f:
    soup = BeautifulSoup(f.read(), "html.parser")

# Extract title
title = soup.find("h1").get_text(strip=True) if soup.find("h1") else (soup.title.get_text(strip=True) if soup.title else "UNKNOWN")

# Extract canonical URL
canonical_url = "UNKNOWN"
link_tag = soup.find("link", rel="canonical")
if link_tag and link_tag.get("href"):
    canonical_url = link_tag["href"]

# Extract table_data if 2-column table exists
table_data = {}
table = soup.find("table")
if table:
    for row in table.find_all("tr"):
        cells = row.find_all("td")
        if len(cells) == 2:
            key = cells[0].get_text(strip=True)
            value = cells[1].get_text(strip=True)
            table_data[key] = value

# Extract sections
sections = []
current_section = None

for tag in soup.find_all(["h2", "h3", "p", "ul", "ol"]):
    if tag.name in ["h2", "h3"]:
        heading = tag.get_text(strip=True)
        current_section = {
            "heading": heading,
            "content": []
        }
        sections.append(current_section)
    elif tag.name == "p":
        text = tag.get_text(strip=True)
        if text and current_section:
            current_section["content"].append(text)
    elif tag.name in ["ul", "ol"]:
        items = [li.get_text(strip=True) for li in tag.find_all("li")]
        if items and current_section:
            current_section["content"].extend(items)

# Extract all <img src=...>
image_urls = []
for img in soup.find_all("img"):
    src = img.get("src")
    if src and src.startswith("http"):
        image_urls.append(src)

# Final output
output_json = {
    "title": title,
    "url": canonical_url,
    "sections": sections,
    "images": image_urls
}
if table_data:
    output_json["table_data"] = table_data

# Save to JSON
with open(json_file, "w", encoding="utf-8") as f:
    json.dump(output_json, f, indent=2)

print(f"âœ… Saved to {json_file}")
